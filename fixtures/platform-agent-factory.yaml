apiVersion: platform.althq.com/v1
kind: Service
metadata:
  name: agent-factory
  description: AI agent platform. TanStack Start orchestrator + AgentCore Runtime agents.

spec:
  compute:
    type: ecs
    port: 3000
    cpu: 512
    memory: 1024
    instances:
      min: 1
    healthCheck:
      path: /health
    publicPaths:
      - /webhooks/*

  dynamodb:
    tables:
      - name: agent-factory-agents
        partitionKey: agent_id
      - name: agent-factory-jobs
        partitionKey: job_id
        ttlAttribute: expires_at
      - name: agent-factory-conversations
        partitionKey: agent_id
        sortKey: session_sk
        ttlAttribute: expires_at

  s3:
    buckets:
      - name: agent-factory-state
        versioning: true

  agentcoreRuntime:
    runtimes:
      - name: claude_agent
        image: claude-agent
        description: Claude Agent SDK runtime (chat + autonomous)
        networkMode: PUBLIC
        environmentVariables:
          WORK_DIR: /tmp/agent
      - name: pi_agent
        image: pi-agent
        description: Pi Agent runtime (chat + autonomous)
        networkMode: PUBLIC
        environmentVariables:
          WORK_DIR: /tmp/agent
    authorizer:
      type: jwt
      discoveryUrl: https://accounts.google.com/.well-known/openid-configuration
      allowedAudiences:
        - agent-factory

  serviceDiscovery:
    namespace: agents.local

  eventbridge:
    scheduleGroup: agent-factory